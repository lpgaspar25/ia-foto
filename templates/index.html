<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Tools - Tradutor & Substituidor</title>
    <style>
        :root {
            --bg-body: #0a0a0a;
            --bg-card: #141414;
            --bg-input: #1a1a1a;
            --bg-elevated: #1e1e1e;
            --border: #252525;
            --border-hover: #3a3a3a;
            --text-primary: #f0f0f0;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.25);
            --accent-subtle: rgba(99, 102, 241, 0.08);
            --accent2: #a855f7;
            --accent2-hover: #c084fc;
            --accent2-glow: rgba(168, 85, 247, 0.25);
            --accent2-subtle: rgba(168, 85, 247, 0.08);
            --success: #10b981;
            --error: #ef4444;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 920px;
            margin: 0 auto;
            padding: 2.5rem 2rem;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .header h1 {
            font-size: 2rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 0.4rem;
            letter-spacing: -0.5px;
        }
        .header p {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 0.35rem;
        }
        .tab {
            flex: 1;
            padding: 0.85rem 1rem;
            text-align: center;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            border: none;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }
        .tab:hover { color: var(--text-primary); background: var(--bg-elevated); }
        .tab.active {
            color: var(--accent-hover);
            background: var(--accent-subtle);
            font-weight: 600;
        }
        .tab.active-green {
            color: var(--accent2-hover);
            background: var(--accent2-subtle);
            font-weight: 600;
        }
        .tab-icon { margin-right: 0.4rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .card h2 {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* Upload */
        .upload-area {
            border: 2px dashed #303030;
            border-radius: var(--radius-md);
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.04);
        }
        .upload-area.has-image {
            border-color: var(--success);
            border-style: solid;
            padding: 1rem;
        }
        .upload-icon { font-size: 2.5rem; margin-bottom: 0.8rem; }
        .upload-text { color: var(--text-secondary); font-size: 0.9rem; }
        .upload-text span { color: var(--accent-hover); font-weight: 500; }
        .upload-area input { display: none; }

        .preview-container {
            display: none;
            align-items: center;
            gap: 1rem;
        }
        .preview-container.visible { display: flex; }
        .preview-img {
            max-width: 120px;
            max-height: 90px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }
        .preview-info { flex: 1; text-align: left; }
        .preview-info .name { font-weight: 500; color: #fff; font-size: 0.9rem; }
        .preview-info .size { color: var(--text-secondary); font-size: 0.8rem; margin-top: 2px; }
        .preview-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: var(--transition);
        }
        .preview-remove:hover { color: var(--error); }

        /* Idiomas */
        .idiomas-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.65rem;
        }
        @media (max-width: 600px) {
            .idiomas-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .idioma-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 0.9rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }
        .idioma-item:hover { border-color: var(--border-hover); background: var(--bg-elevated); }
        .idioma-item.selected {
            border-color: var(--accent);
            background: var(--accent-subtle);
        }
        .idioma-item input { display: none; }
        .idioma-check {
            width: 18px; height: 18px;
            border: 2px solid #404040;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: var(--transition);
            flex-shrink: 0;
        }
        .idioma-item.selected .idioma-check {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }
        .idioma-flag { font-size: 1.1rem; }
        .idioma-name { font-size: 0.85rem; color: var(--text-primary); }
        .select-all-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.4rem 0.8rem;
            border-radius: var(--radius-sm);
            font-size: 0.78rem;
            cursor: pointer;
            float: right;
            margin-top: -1.8rem;
            transition: var(--transition);
        }
        .select-all-btn:hover { border-color: var(--accent); color: var(--accent-hover); }

        /* Marca */
        .marca-row {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        @media (max-width: 600px) {
            .marca-row { flex-direction: column; }
        }
        .marca-field { flex: 1; }
        .marca-field label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }
        .marca-field input {
            width: 100%;
            padding: 0.7rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: #fff;
            font-size: 0.9rem;
            outline: none;
            transition: var(--transition);
        }
        .marca-field input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .marca-field input::placeholder { color: #404040; }
        .marca-arrow {
            font-size: 1.3rem;
            color: #404040;
            margin-top: 1.2rem;
        }
        .marca-hint {
            color: var(--text-muted);
            font-size: 0.78rem;
            margin-top: 0.6rem;
        }

        /* Bot√£o Traduzir */
        .btn-traduzir {
            width: 100%;
            padding: 1rem;
            background: var(--accent);
            border: none;
            border-radius: var(--radius-md);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            letter-spacing: 0.3px;
            box-shadow: 0 2px 10px var(--accent-glow);
        }
        .btn-traduzir:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--accent-glow);
        }
        .btn-traduzir:disabled {
            background: #1e1e1e;
            color: #505050;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .loading.visible { display: block; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: var(--text-secondary); font-size: 0.9rem; }
        .loading-lang { color: var(--accent-hover); font-weight: 600; }

        /* Resultados */
        .resultados { display: none; }
        .resultados.visible { display: block; }
        .resultado-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        .resultado-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: var(--transition);
        }
        .resultado-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-color: var(--border-hover);
        }
        .resultado-item.erro { border-color: var(--error); }
        .resultado-img {
            width: 100%;
            aspect-ratio: 16/10;
            object-fit: contain;
            background: #0d0d0d;
            display: block;
        }
        .resultado-footer {
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .resultado-lang {
            font-size: 0.85rem;
            font-weight: 500;
        }
        .resultado-lang .flag { margin-right: 0.3rem; }
        .resultado-size { color: var(--text-muted); font-size: 0.75rem; }
        .btn-download {
            background: var(--accent);
            border: none;
            color: #fff;
            padding: 0.45rem 0.9rem;
            border-radius: var(--radius-sm);
            font-size: 0.78rem;
            cursor: pointer;
            text-decoration: none;
            transition: var(--transition);
        }
        .btn-download:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px var(--accent-glow);
        }
        .resultado-erro {
            padding: 1.5rem;
            text-align: center;
            color: var(--error);
            font-size: 0.85rem;
        }

        .btn-novo {
            display: inline-block;
            margin-top: 1.2rem;
            padding: 0.6rem 1.2rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
            transition: var(--transition);
        }
        .btn-novo:hover { border-color: var(--accent); color: var(--accent-hover); }

        /* Substituir - uploads lado a lado */
        .dual-upload {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
        }
        @media (max-width: 600px) {
            .dual-upload { grid-template-columns: 1fr; }
            .dual-arrow { transform: rotate(90deg); }
        }
        .dual-arrow {
            font-size: 1.5rem;
            color: #404040;
            text-align: center;
        }
        .upload-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: block;
        }
        .upload-area-mini {
            border: 2px dashed #303030;
            border-radius: var(--radius-md);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        .upload-area-mini:hover { border-color: var(--accent2); background: rgba(168, 85, 247, 0.04); }
        .upload-area-mini.has-image { border-color: var(--success); border-style: solid; padding: 0.8rem; }
        .upload-area-mini input { display: none; }
        .upload-area-mini .upload-icon { font-size: 1.8rem; margin-bottom: 0.4rem; }
        .upload-area-mini .upload-text { font-size: 0.8rem; }
        .mini-preview { max-width: 100%; max-height: 100px; border-radius: var(--radius-sm); }

        .instrucoes-field textarea {
            width: 100%;
            padding: 0.7rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: #fff;
            font-size: 0.85rem;
            outline: none;
            resize: vertical;
            min-height: 70px;
            font-family: inherit;
            transition: var(--transition);
        }
        .instrucoes-field textarea:focus {
            border-color: var(--accent2);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        .instrucoes-field textarea::placeholder { color: #404040; }

        /* Bot√£o Substituir */
        .btn-substituir {
            width: 100%;
            padding: 1rem;
            background: var(--accent2);
            border: none;
            border-radius: var(--radius-md);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 10px var(--accent2-glow);
        }
        .btn-substituir:hover {
            background: var(--accent2-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--accent2-glow);
        }
        .btn-substituir:disabled {
            background: #1e1e1e; color: #505050; cursor: not-allowed; transform: none; box-shadow: none;
        }

        /* Resultado substitui√ß√£o */
        .sub-resultado { display: none; }
        .sub-resultado.visible { display: block; }
        .sub-resultado-img {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: var(--radius-md);
            background: #0d0d0d;
            display: block;
            margin-bottom: 1rem;
        }
        .sub-resultado-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Multi-file preview list */
        .files-list { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .file-thumb {
            position: relative;
            width: 100px; height: 100px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid var(--border);
            cursor: default;
            transition: var(--transition);
        }
        .file-thumb:hover { border-color: var(--border-hover); transform: scale(1.02); }
        .file-thumb img {
            width: 100%; height: 100%;
            object-fit: cover;
        }
        .file-thumb .file-remove {
            position: absolute; top: 4px; right: 4px;
            background: rgba(0,0,0,0.75); color: #fff;
            border: none; border-radius: 50%;
            width: 22px; height: 22px;
            font-size: 11px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition);
            backdrop-filter: blur(4px);
        }
        .file-thumb .file-remove:hover { background: var(--error); }
        .file-thumb .file-name {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.75);
            backdrop-filter: blur(4px);
            color: #fff; font-size: 0.6rem;
            padding: 3px 5px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .file-count {
            color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;
        }

        /* ‚ïê‚ïê‚ïê Accent3 ‚Äî CSV Shopify (teal) ‚ïê‚ïê‚ïê */
        :root {
            --accent3: #14b8a6;
            --accent3-hover: #2dd4bf;
            --accent3-glow: rgba(20, 184, 166, 0.25);
            --accent3-subtle: rgba(20, 184, 166, 0.08);
        }
        .tab.active-teal {
            color: var(--accent3-hover);
            background: var(--accent3-subtle);
            font-weight: 600;
        }
        .btn-csv {
            width: 100%;
            padding: 1rem;
            background: var(--accent3);
            border: none;
            border-radius: var(--radius-md);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 10px var(--accent3-glow);
        }
        .btn-csv:hover {
            background: var(--accent3-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--accent3-glow);
        }
        .btn-csv:disabled {
            background: #1e1e1e; color: #505050; cursor: not-allowed; transform: none; box-shadow: none;
        }

        /* CSV Phase containers */
        .csv-phase { display: none; }
        .csv-phase.visible { display: block; }

        /* CSV Upload area */
        .csv-upload-area {
            border: 2px dashed #303030;
            border-radius: var(--radius-md);
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        .csv-upload-area:hover { border-color: var(--accent3); background: rgba(20, 184, 166, 0.04); }
        .csv-upload-area.has-file { border-color: var(--success); border-style: solid; }
        .csv-upload-area input { display: none; }

        /* Image review table */
        .img-review-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.4rem;
        }
        .img-review-table th {
            text-align: left;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.4rem 0.6rem;
        }
        .img-review-table td {
            padding: 0.5rem 0.6rem;
            background: var(--bg-input);
            font-size: 0.85rem;
            vertical-align: middle;
        }
        .img-review-table tr td:first-child { border-radius: var(--radius-sm) 0 0 var(--radius-sm); }
        .img-review-table tr td:last-child { border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }
        .img-review-thumb {
            width: 60px; height: 60px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-gallery { background: rgba(99,102,241,0.15); color: #818cf8; }
        .badge-variant { background: rgba(168,85,247,0.15); color: #c084fc; }
        .badge-description { background: rgba(20,184,166,0.15); color: #2dd4bf; }
        .text-indicator {
            display: flex; align-items: center; gap: 0.3rem;
            font-size: 0.82rem;
        }
        .text-indicator.has-text { color: var(--success); }
        .text-indicator.no-text { color: var(--text-muted); }

        .csv-checkbox {
            width: 18px; height: 18px;
            accent-color: var(--accent3);
            cursor: pointer;
        }

        /* Selection buttons row */
        .selection-btns {
            display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;
        }
        .selection-btns button {
            padding: 0.4rem 0.8rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-size: 0.78rem;
            cursor: pointer;
            transition: var(--transition);
        }
        .selection-btns button:hover { border-color: var(--accent3); color: var(--accent3-hover); }

        /* Progress bar */
        .csv-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .csv-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent3), var(--accent3-hover));
            border-radius: 4px;
            transition: width 0.4s ease;
            width: 0%;
        }
        .csv-progress-text {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        .csv-progress-percent {
            color: var(--accent3-hover);
            font-weight: 600;
        }

        /* Translated images grid */
        .csv-result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .csv-result-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            text-align: center;
        }
        .csv-result-item img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }
        .csv-result-item .label {
            padding: 0.3rem 0.5rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Info / summary */
        .csv-summary {
            display: flex; gap: 1.5rem; flex-wrap: wrap;
            padding: 1rem;
            background: var(--bg-input);
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
        }
        .csv-summary-item {
            text-align: center;
        }
        .csv-summary-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent3-hover);
        }
        .csv-summary-item .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Estimate text */
        .csv-estimate {
            color: var(--text-muted);
            font-size: 0.82rem;
            margin-top: 0.75rem;
            text-align: center;
        }

        /* CSV idiomas grid (reuse) */
        .csv-idiomas-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.65rem;
        }
        @media (max-width: 600px) {
            .csv-idiomas-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- Header -->
        <div class="header">
            <h1>Image Tools</h1>
            <p>Ferramentas de IA para imagens de produtos</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('traduzir')">
                <span class="tab-icon">üåç</span> Traduzir Imagem
            </div>
            <div class="tab" onclick="switchTab('substituir')">
                <span class="tab-icon">üîÑ</span> Substituir Produto
            </div>
            <div class="tab" onclick="switchTab('csv')">
                <span class="tab-icon">üìã</span> CSV Shopify
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ABA 1: TRADUZIR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="tab-content active" id="tab-traduzir">

        <!-- Upload -->
        <div class="card" id="uploadCard">
            <h2>Imagens</h2>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div id="uploadPlaceholder">
                    <div class="upload-icon">üñºÔ∏è</div>
                    <div class="upload-text">
                        Arraste suas imagens aqui ou <span>clique para selecionar</span>
                    </div>
                    <div class="upload-text" style="margin-top:0.3rem; font-size:0.78rem;">
                        PNG, JPG, WEBP (m&aacute;x 16MB) &middot; M&uacute;ltiplas imagens
                    </div>
                </div>
                <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.webp" multiple>
            </div>
            <div id="filesPreviewList" style="display:none; margin-top:0.75rem;"></div>
            <button class="preview-remove" id="removeBtn" style="display:none; margin-top:0.5rem;" onclick="removerTodasImagens(event)">
                ‚úï Remover todas
            </button>
        </div>

        <!-- Idiomas -->
        <div class="card">
            <h2>Idiomas</h2>
            <button class="select-all-btn" onclick="toggleSelectAll()">Selecionar todos</button>
            <div class="idiomas-grid" id="idiomasGrid">
                {% for code, name in idiomas.items() %}
                <label class="idioma-item" data-code="{{ code }}">
                    <input type="checkbox" name="idiomas" value="{{ code }}">
                    <div class="idioma-check">‚úì</div>
                    <span class="idioma-flag">
                        {% if code == 'en' %}üá¨üáß{% elif code == 'es' %}üá™üá∏{% elif code == 'fr' %}üá´üá∑{% elif code == 'it' %}üáÆüáπ{% elif code == 'de' %}üá©üá™{% elif code == 'nl' %}üá≥üá±{% endif %}
                    </span>
                    <span class="idioma-name">{{ name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- Marca -->
        <div class="card">
            <h2>Trocar Marca <span style="font-weight:400; color:#666; text-transform:none;">(opcional)</span></h2>
            <div class="marca-row">
                <div class="marca-field">
                    <label>Marca original na imagem</label>
                    <input type="text" id="marcaDe" placeholder="Ex: HEFESTUS">
                </div>
                <div class="marca-arrow">‚Üí</div>
                <div class="marca-field">
                    <label>Sua marca</label>
                    <input type="text" id="marcaPara" placeholder="Ex: MULTIALPHA">
                </div>
            </div>
            <div class="marca-hint">Deixe em branco para manter a marca original</div>
        </div>

        <!-- Bot&atilde;o -->
        <button class="btn-traduzir" id="btnTraduzir" onclick="traduzir()" disabled>
            Traduzir Imagem
        </button>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">
                Traduzindo para <span class="loading-lang" id="loadingLang">...</span>
            </div>
            <div class="loading-text" style="margin-top:0.3rem; font-size:0.8rem; color:#666;">
                Cada idioma leva ~15-30 segundos
            </div>
        </div>

        <!-- Resultados -->
        <div class="resultados" id="resultados">
            <div class="card">
                <h2>Resultados</h2>
                <div class="resultado-grid" id="resultadoGrid"></div>
                <button class="btn-novo" onclick="novaTraducao()">‚Üê Nova tradu&ccedil;&atilde;o</button>
            </div>
        </div>

        </div><!-- /tab-traduzir -->

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ABA 2: SUBSTITUIR PRODUTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="tab-content" id="tab-substituir">

            <!-- Upload duplo -->
            <div class="card">
                <h2>Imagens</h2>
                <div class="dual-upload">
                    <div>
                        <span class="upload-label">Imagem A ‚Äî Produto (refer√™ncia)</span>
                        <div class="upload-area-mini" id="subUploadA" onclick="document.getElementById('subFileA').click()">
                            <div id="subPlaceholderA">
                                <div class="upload-icon">üì∑</div>
                                <div class="upload-text">Foto com o produto original</div>
                            </div>
                            <img class="mini-preview" id="subPreviewA" style="display:none">
                            <input type="file" id="subFileA" accept=".png,.jpg,.jpeg,.webp">
                        </div>
                    </div>
                    <div class="dual-arrow">‚Üí</div>
                    <div>
                        <span class="upload-label">Imagem B ‚Äî Cena / Lifestyle (editar)</span>
                        <div class="upload-area-mini" id="subUploadB" onclick="document.getElementById('subFileB').click()">
                            <div id="subPlaceholderB">
                                <div class="upload-icon">üõçÔ∏è</div>
                                <div class="upload-text">Foto do produto que vai substituir</div>
                            </div>
                            <img class="mini-preview" id="subPreviewB" style="display:none">
                            <input type="file" id="subFileB" accept=".png,.jpg,.jpeg,.webp">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instru&ccedil;&otilde;es extras -->
            <div class="card">
                <h2>Instru&ccedil;&otilde;es extras <span style="font-weight:400; color:#666; text-transform:none;">(opcional)</span></h2>
                <div class="instrucoes-field">
                    <textarea id="subInstrucoes" placeholder="Ex: O produto &eacute; um rel&oacute;gio. Manter o mesmo encaixe no pulso. Preservar tatuagens vis&iacute;veis."></textarea>
                </div>
            </div>

            <!-- Bot&atilde;o -->
            <button class="btn-substituir" id="btnSubstituir" onclick="substituir()" disabled>
                Substituir Produto
            </button>

            <!-- Loading -->
            <div class="loading" id="subLoading">
                <div class="spinner" style="border-top-color:#22c55e;"></div>
                <div class="loading-text">
                    Processando substitui&ccedil;&atilde;o com <span class="loading-lang" style="color:#22c55e;">Gemini AI</span>
                </div>
                <div class="loading-text" style="margin-top:0.3rem; font-size:0.8rem; color:#666;">
                    Isso pode levar ~30-60 segundos
                </div>
            </div>

            <!-- Resultado -->
            <div class="sub-resultado" id="subResultado">
                <div class="card">
                    <h2>Resultado</h2>
                    <img class="sub-resultado-img" id="subResultImg" src="">
                    <div class="sub-resultado-footer">
                        <div>
                            <span style="color:#22c55e; font-weight:500;">Substitui&ccedil;&atilde;o conclu&iacute;da</span>
                            <span id="subResultSize" style="color:#666; font-size:0.8rem; margin-left:0.5rem;"></span>
                        </div>
                        <a class="btn-download" id="subDownloadBtn" href="#" download style="background:#16a34a; border-color:#16a34a; color:#fff;">
                            ‚¨á Download JPG
                        </a>
                    </div>
                    <button class="btn-novo" onclick="novaSubstituicao()" style="margin-top:1rem;">‚Üê Nova substitui&ccedil;&atilde;o</button>
                </div>
            </div>

        </div><!-- /tab-substituir -->

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ABA 3: CSV SHOPIFY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="tab-content" id="tab-csv">

            <!-- Fase 1: Upload CSV -->
            <div class="csv-phase visible" id="csvPhase1">
                <div class="card">
                    <h2>Upload CSV Shopify</h2>
                    <div class="csv-upload-area" id="csvUploadArea" onclick="document.getElementById('csvFileInput').click()">
                        <div id="csvPlaceholder">
                            <div class="upload-icon">üìã</div>
                            <div class="upload-text">
                                Arraste seu CSV aqui ou <span style="color:var(--accent3-hover); font-weight:500;">clique para selecionar</span>
                            </div>
                            <div class="upload-text" style="margin-top:0.3rem; font-size:0.78rem;">
                                Exportado do Shopify (products_export.csv)
                            </div>
                        </div>
                        <div id="csvFileInfo" style="display:none;">
                            <div style="font-size:1.5rem; margin-bottom:0.5rem;">üìÑ</div>
                            <div style="color:#fff; font-weight:500;" id="csvFileName"></div>
                            <div style="color:var(--text-secondary); font-size:0.8rem; margin-top:0.2rem;" id="csvFileSize"></div>
                        </div>
                        <input type="file" id="csvFileInput" accept=".csv">
                    </div>
                </div>

                <button class="btn-csv" id="btnAnalisar" onclick="analisarCSV()" disabled>
                    Analisar CSV
                </button>

                <div class="loading" id="csvLoading1">
                    <div class="spinner" style="border-top-color: var(--accent3);"></div>
                    <div class="loading-text">
                        Analisando imagens com <span class="loading-lang" style="color:var(--accent3-hover);">GPT-4o Vision</span>
                    </div>
                    <div class="loading-text" style="margin-top:0.3rem; font-size:0.8rem; color:#666;">
                        Baixando e detectando texto nas imagens...
                    </div>
                </div>
            </div>

            <!-- Fase 2: Revis√£o de imagens -->
            <div class="csv-phase" id="csvPhase2">
                <div class="card">
                    <h2>Imagens encontradas</h2>
                    <div class="csv-summary" id="csvSummary"></div>

                    <div class="selection-btns">
                        <button onclick="csvSelectText()">‚úÖ Selecionar com texto</button>
                        <button onclick="csvSelectAll()">Selecionar todas</button>
                        <button onclick="csvSelectNone()">Limpar sele√ß√£o</button>
                    </div>

                    <div style="overflow-x:auto;">
                        <table class="img-review-table" id="csvImageTable">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Preview</th>
                                    <th>Tipo</th>
                                    <th>Produto</th>
                                    <th>Texto?</th>
                                    <th>Descri√ß√£o AI</th>
                                </tr>
                            </thead>
                            <tbody id="csvImageTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tradu√ß√£o de Texto -->
                <div class="card">
                    <h2>üìù Tradu√ß√£o de Texto</h2>
                    <label style="display:flex; align-items:center; gap:0.6rem; cursor:pointer; padding:0.6rem 0;">
                        <input type="checkbox" id="csvTraduzirTexto" checked style="width:18px; height:18px; accent-color:var(--accent3); cursor:pointer;"
                               onchange="updateCsvTraduzirBtn()">
                        <div>
                            <div style="color:var(--text-primary); font-size:0.9rem; font-weight:500;">
                                Traduzir descri√ß√µes do produto
                            </div>
                            <div style="color:var(--text-muted); font-size:0.78rem; margin-top:0.15rem;">
                                Inclui: t√≠tulo, especifica√ß√µes t√©cnicas, descri√ß√£o HTML, SEO e tags
                            </div>
                        </div>
                    </label>
                </div>

                <!-- Idiomas CSV -->
                <div class="card">
                    <h2>Idiomas</h2>
                    <button class="select-all-btn" onclick="csvToggleAllIdiomas()">Selecionar todos</button>
                    <div class="csv-idiomas-grid" id="csvIdiomasGrid">
                        {% for code, name in idiomas.items() %}
                        <label class="idioma-item csv-idioma-item" data-code="{{ code }}">
                            <input type="checkbox" name="csv_idiomas" value="{{ code }}">
                            <div class="idioma-check">‚úì</div>
                            <span class="idioma-flag">
                                {% if code == 'en' %}üá¨üáß{% elif code == 'es' %}üá™üá∏{% elif code == 'fr' %}üá´üá∑{% elif code == 'it' %}üáÆüáπ{% elif code == 'de' %}üá©üá™{% elif code == 'nl' %}üá≥üá±{% endif %}
                            </span>
                            <span class="idioma-name">{{ name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Marca CSV -->
                <div class="card">
                    <h2>Trocar Marca <span style="font-weight:400; color:#666; text-transform:none;">(opcional)</span></h2>
                    <div class="marca-row">
                        <div class="marca-field">
                            <label>Marca original</label>
                            <input type="text" id="csvMarcaDe" placeholder="Ex: HEFESTUS">
                        </div>
                        <div class="marca-arrow">‚Üí</div>
                        <div class="marca-field">
                            <label>Sua marca</label>
                            <input type="text" id="csvMarcaPara" placeholder="Ex: MULTIALPHA">
                        </div>
                    </div>
                    <div class="marca-hint">Aplica nas imagens e no texto da descri√ß√£o</div>
                </div>

                <button class="btn-csv" id="btnTraduzirCSV" onclick="iniciarTraducaoCSV()" disabled>
                    Traduzir Selecionadas
                </button>
                <div class="csv-estimate" id="csvEstimate"></div>
            </div>

            <!-- Fase 3: Progresso e Download -->
            <div class="csv-phase" id="csvPhase3">
                <div class="card">
                    <h2>Tradu√ß√£o em andamento</h2>
                    <div class="csv-progress-text">
                        <span id="csvProgressLabel">Preparando...</span>
                        <span class="csv-progress-percent" id="csvProgressPercent">0%</span>
                    </div>
                    <div class="csv-progress-bar">
                        <div class="csv-progress-fill" id="csvProgressFill"></div>
                    </div>

                    <div class="csv-result-grid" id="csvResultGrid"></div>
                </div>

                <div id="csvDownloadArea" style="display:none; margin-top:1rem;">
                    <a class="btn-csv" id="csvDownloadBtn" href="#" download style="display:block; text-align:center; text-decoration:none;">
                        ‚¨á Baixar ZIP com tradu√ß√µes
                    </a>
                    <button class="btn-novo" onclick="novaAnaliseCSV()" style="margin-top:1rem;">‚Üê Nova an√°lise</button>
                </div>
            </div>

        </div><!-- /tab-csv -->

    </div>

    <script>
        const FLAGS = {en:'üá¨üáß', es:'üá™üá∏', fr:'üá´üá∑', it:'üáÆüáπ', de:'üá©üá™', nl:'üá≥üá±'};
        let selectedFiles = [];

        // ‚îÄ‚îÄ‚îÄ Upload (m√∫ltiplas imagens) ‚îÄ‚îÄ‚îÄ
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        ['dragenter','dragover'].forEach(e => {
            uploadArea.addEventListener(e, ev => { ev.preventDefault(); uploadArea.classList.add('dragover'); });
        });
        ['dragleave','drop'].forEach(e => {
            uploadArea.addEventListener(e, ev => { ev.preventDefault(); uploadArea.classList.remove('dragover'); });
        });
        uploadArea.addEventListener('drop', ev => {
            const files = [...ev.dataTransfer.files];
            files.forEach(f => addFile(f));
        });
        fileInput.addEventListener('change', ev => {
            [...ev.target.files].forEach(f => addFile(f));
            fileInput.value = '';
        });

        function addFile(file) {
            if (!file.type.match(/image\/(png|jpeg|webp)/)) {
                alert('Formato n√£o suportado: ' + file.name + '. Use PNG, JPG ou WEBP.');
                return;
            }
            // Evitar duplicatas pelo nome
            if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) return;
            selectedFiles.push(file);
            renderFilesPreviews();
            checkReady();
        }

        function renderFilesPreviews() {
            const list = document.getElementById('filesPreviewList');
            if (selectedFiles.length === 0) {
                list.style.display = 'none';
                document.getElementById('uploadPlaceholder').style.display = '';
                document.getElementById('removeBtn').style.display = 'none';
                uploadArea.classList.remove('has-image');
                return;
            }

            document.getElementById('uploadPlaceholder').style.display = 'none';
            document.getElementById('removeBtn').style.display = 'block';
            uploadArea.classList.add('has-image');
            list.style.display = 'block';

            list.innerHTML = `<div class="file-count">${selectedFiles.length} imagem(ns) selecionada(s)</div><div class="files-list"></div>`;
            const grid = list.querySelector('.files-list');

            selectedFiles.forEach((file, idx) => {
                const thumb = document.createElement('div');
                thumb.className = 'file-thumb';
                const reader = new FileReader();
                reader.onload = e => {
                    thumb.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <button class="file-remove" onclick="removeFile(${idx}, event)" title="Remover">‚úï</button>
                        <div class="file-name">${file.name}</div>
                    `;
                };
                reader.readAsDataURL(file);
                grid.appendChild(thumb);
            });
        }

        function removeFile(idx, ev) {
            if (ev) ev.stopPropagation();
            selectedFiles.splice(idx, 1);
            renderFilesPreviews();
            checkReady();
        }

        function removerTodasImagens(ev) {
            if (ev) ev.stopPropagation();
            selectedFiles = [];
            fileInput.value = '';
            renderFilesPreviews();
            checkReady();
        }

        // ‚îÄ‚îÄ‚îÄ Idiomas ‚îÄ‚îÄ‚îÄ
        document.querySelectorAll('.idioma-item').forEach(item => {
            item.addEventListener('click', () => {
                const cb = item.querySelector('input');
                cb.checked = !cb.checked;
                item.classList.toggle('selected', cb.checked);
                checkReady();
            });
        });

        function toggleSelectAll() {
            const items = document.querySelectorAll('.idioma-item');
            const allSelected = [...items].every(i => i.classList.contains('selected'));
            items.forEach(item => {
                const cb = item.querySelector('input');
                cb.checked = !allSelected;
                item.classList.toggle('selected', !allSelected);
            });
            checkReady();
        }

        function checkReady() {
            const hasFiles = selectedFiles.length > 0;
            const hasIdioma = document.querySelectorAll('.idioma-item.selected').length > 0;
            document.getElementById('btnTraduzir').disabled = !(hasFiles && hasIdioma);
        }

        // ‚îÄ‚îÄ‚îÄ Traduzir ‚îÄ‚îÄ‚îÄ
        async function traduzir() {
            const idiomas = [...document.querySelectorAll('.idioma-item.selected')]
                .map(i => i.dataset.code);
            const marcaDe = document.getElementById('marcaDe').value.trim();
            const marcaPara = document.getElementById('marcaPara').value.trim();

            const formData = new FormData();
            selectedFiles.forEach(f => formData.append('imagens', f));
            idiomas.forEach(l => formData.append('idiomas', l));
            formData.append('marca_de', marcaDe);
            formData.append('marca_para', marcaPara);

            // UI: loading
            document.getElementById('btnTraduzir').disabled = true;
            document.getElementById('loading').classList.add('visible');
            document.getElementById('resultados').classList.remove('visible');
            document.getElementById('loadingLang').textContent = idiomas.map(c =>
                FLAGS[c] + ' ' + c.toUpperCase()
            ).join(', ');

            try {
                const resp = await fetch('/traduzir', { method: 'POST', body: formData });
                const data = await resp.json();

                if (data.erro) {
                    alert('Erro: ' + data.erro);
                    return;
                }

                mostrarResultados(data.resultados);
            } catch (err) {
                alert('Erro de conex√£o: ' + err.message);
            } finally {
                document.getElementById('loading').classList.remove('visible');
                document.getElementById('btnTraduzir').disabled = false;
            }
        }

        function mostrarResultados(resultados) {
            const grid = document.getElementById('resultadoGrid');
            grid.innerHTML = '';

            // Agrupar por imagem original se houver m√∫ltiplas
            const porImagem = {};
            resultados.forEach(r => {
                const key = r.imagem_original || 'default';
                if (!porImagem[key]) porImagem[key] = [];
                porImagem[key].push(r);
            });

            const keys = Object.keys(porImagem);
            const multiImagem = keys.length > 1;

            keys.forEach(key => {
                if (multiImagem) {
                    grid.innerHTML += `<div style="grid-column:1/-1; margin-top:1rem; padding:0.5rem 0; border-bottom:1px solid #333; color:#aaa; font-size:0.85rem;">üìÅ ${key}</div>`;
                }

                porImagem[key].forEach(r => {
                    if (r.erro) {
                        grid.innerHTML += `
                            <div class="resultado-item erro">
                                <div class="resultado-erro">
                                    ${FLAGS[r.idioma]} ${r.idioma_nome}<br>
                                    ‚ùå ${r.erro}
                                </div>
                            </div>`;
                    } else {
                        grid.innerHTML += `
                            <div class="resultado-item">
                                <img class="resultado-img" src="${r.preview}" alt="${r.idioma_nome}">
                                <div class="resultado-footer">
                                    <div>
                                        <div class="resultado-lang">
                                            <span class="flag">${FLAGS[r.idioma]}</span>${r.idioma_nome}
                                        </div>
                                        <div class="resultado-size">${r.tamanho_kb} KB ¬∑ JPG</div>
                                    </div>
                                    <a class="btn-download" href="${r.download_url}" download>
                                        ‚¨á Download
                                    </a>
                                </div>
                            </div>`;
                    }
                });
            });

            document.getElementById('resultados').classList.add('visible');
        }

        function novaTraducao() {
            document.getElementById('resultados').classList.remove('visible');
            removerTodasImagens();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active', 'active-green', 'active-teal'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'traduzir') {
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else if (tab === 'substituir') {
                document.querySelectorAll('.tab')[1].classList.add('active-green');
            } else if (tab === 'csv') {
                document.querySelectorAll('.tab')[2].classList.add('active-teal');
            }
            document.getElementById('tab-' + tab).classList.add('active');
        }

        // ‚îÄ‚îÄ‚îÄ Substituir Produto ‚îÄ‚îÄ‚îÄ
        let subFileA = null, subFileB = null;

        document.getElementById('subFileA').addEventListener('change', ev => {
            if (ev.target.files[0]) handleSubFile('A', ev.target.files[0]);
        });
        document.getElementById('subFileB').addEventListener('change', ev => {
            if (ev.target.files[0]) handleSubFile('B', ev.target.files[0]);
        });

        function handleSubFile(side, file) {
            if (!file.type.match(/image\/(png|jpeg|webp)/)) { alert('Use PNG, JPG ou WEBP.'); return; }
            if (side === 'A') subFileA = file; else subFileB = file;

            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById('subPreview' + side);
                const placeholder = document.getElementById('subPlaceholder' + side);
                const area = document.getElementById('subUpload' + side);
                preview.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                area.classList.add('has-image');
                checkSubReady();
            };
            reader.readAsDataURL(file);
        }

        function checkSubReady() {
            document.getElementById('btnSubstituir').disabled = !(subFileA && subFileB);
        }

        async function substituir() {
            const formData = new FormData();
            formData.append('imagem_cena', subFileA);
            formData.append('imagem_produto', subFileB);
            formData.append('instrucoes', document.getElementById('subInstrucoes').value.trim());

            document.getElementById('btnSubstituir').disabled = true;
            document.getElementById('subLoading').classList.add('visible');
            document.getElementById('subResultado').classList.remove('visible');

            try {
                const resp = await fetch('/substituir', { method: 'POST', body: formData });
                const data = await resp.json();

                if (data.erro) {
                    alert('Erro: ' + data.erro);
                    return;
                }

                document.getElementById('subResultImg').src = data.preview;
                document.getElementById('subDownloadBtn').href = data.download_url;
                document.getElementById('subResultSize').textContent = data.tamanho_kb + ' KB';
                document.getElementById('subResultado').classList.add('visible');
            } catch (err) {
                alert('Erro: ' + err.message);
            } finally {
                document.getElementById('subLoading').classList.remove('visible');
                document.getElementById('btnSubstituir').disabled = false;
            }
        }

        function novaSubstituicao() {
            document.getElementById('subResultado').classList.remove('visible');
            // Reset uploads
            subFileA = null; subFileB = null;
            ['A','B'].forEach(s => {
                document.getElementById('subPreview' + s).style.display = 'none';
                document.getElementById('subPlaceholder' + s).style.display = '';
                document.getElementById('subUpload' + s).classList.remove('has-image');
                document.getElementById('subFile' + s).value = '';
            });
            document.getElementById('subInstrucoes').value = '';
            checkSubReady();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ‚îÄ‚îÄ‚îÄ CSV Shopify ‚îÄ‚îÄ‚îÄ
        let csvFile = null;
        let csvJobId = null;
        let csvImages = [];

        // Upload CSV
        const csvUploadArea = document.getElementById('csvUploadArea');
        const csvFileInput = document.getElementById('csvFileInput');

        ['dragenter','dragover'].forEach(e => {
            csvUploadArea.addEventListener(e, ev => { ev.preventDefault(); csvUploadArea.style.borderColor = 'var(--accent3)'; });
        });
        ['dragleave','drop'].forEach(e => {
            csvUploadArea.addEventListener(e, ev => { ev.preventDefault(); csvUploadArea.style.borderColor = ''; });
        });
        csvUploadArea.addEventListener('drop', ev => {
            const f = ev.dataTransfer.files[0];
            if (f && f.name.endsWith('.csv')) setCsvFile(f);
            else alert('Envie um arquivo .csv');
        });
        csvFileInput.addEventListener('change', ev => {
            if (ev.target.files[0]) setCsvFile(ev.target.files[0]);
        });

        function setCsvFile(file) {
            csvFile = file;
            document.getElementById('csvPlaceholder').style.display = 'none';
            document.getElementById('csvFileInfo').style.display = 'block';
            document.getElementById('csvFileName').textContent = file.name;
            document.getElementById('csvFileSize').textContent = (file.size / 1024).toFixed(0) + ' KB';
            csvUploadArea.classList.add('has-file');
            document.getElementById('btnAnalisar').disabled = false;
        }

        // Idiomas CSV
        document.querySelectorAll('.csv-idioma-item').forEach(item => {
            item.addEventListener('click', () => {
                const cb = item.querySelector('input');
                cb.checked = !cb.checked;
                item.classList.toggle('selected', cb.checked);
                updateCsvTraduzirBtn();
            });
        });

        function csvToggleAllIdiomas() {
            const items = document.querySelectorAll('.csv-idioma-item');
            const allSel = [...items].every(i => i.classList.contains('selected'));
            items.forEach(item => {
                const cb = item.querySelector('input');
                cb.checked = !allSel;
                item.classList.toggle('selected', !allSel);
            });
            updateCsvTraduzirBtn();
        }

        function getSelectedCsvIdiomas() {
            return [...document.querySelectorAll('.csv-idioma-item.selected')].map(i => i.dataset.code);
        }

        function getSelectedCsvImages() {
            return [...document.querySelectorAll('.csv-checkbox:checked')].map(cb => parseInt(cb.dataset.index));
        }

        function updateCsvTraduzirBtn() {
            const imgs = getSelectedCsvImages().length;
            const langs = getSelectedCsvIdiomas().length;
            const traduzirTexto = document.getElementById('csvTraduzirTexto').checked;
            const btn = document.getElementById('btnTraduzirCSV');
            const est = document.getElementById('csvEstimate');

            // Habilitar se tem idioma E (tem imagens selecionadas OU traduzir texto)
            btn.disabled = !(langs > 0 && (imgs > 0 || traduzirTexto));

            if (langs > 0 && (imgs > 0 || traduzirTexto)) {
                const imgTasks = imgs * langs;
                // Estimar produtos √∫nicos (usar csvImages)
                const uniqueHandles = [...new Set(csvImages.map(i => i.handle))].length;
                const textTasks = traduzirTexto ? uniqueHandles * langs : 0;
                const totalTasks = imgTasks + textTasks;
                const mins = Math.ceil((imgTasks * 20 + textTasks * 5) / 60);

                let label = '';
                if (imgs > 0 && traduzirTexto) {
                    label = `Traduzir ${imgs} imagem(ns) + texto √ó ${langs} idioma(s)`;
                } else if (imgs > 0) {
                    label = `Traduzir ${imgs} imagem(ns) √ó ${langs} idioma(s)`;
                } else {
                    label = `Traduzir texto √ó ${langs} idioma(s)`;
                }
                btn.textContent = label;
                est.textContent = `Estimativa: ~${mins} minuto(s) ¬∑ ${totalTasks} tarefas`;
            } else {
                btn.textContent = 'Traduzir Selecionadas';
                est.textContent = '';
            }
        }

        // Selection helpers
        function csvSelectText() {
            document.querySelectorAll('.csv-checkbox').forEach(cb => {
                cb.checked = cb.dataset.hasText === 'true';
            });
            updateCsvTraduzirBtn();
        }
        function csvSelectAll() {
            document.querySelectorAll('.csv-checkbox').forEach(cb => { cb.checked = true; });
            updateCsvTraduzirBtn();
        }
        function csvSelectNone() {
            document.querySelectorAll('.csv-checkbox').forEach(cb => { cb.checked = false; });
            updateCsvTraduzirBtn();
        }

        // Fase 1: Analisar CSV
        async function analisarCSV() {
            if (!csvFile) return;

            const formData = new FormData();
            formData.append('csv_file', csvFile);

            document.getElementById('btnAnalisar').disabled = true;
            document.getElementById('csvLoading1').classList.add('visible');

            try {
                const resp = await fetch('/csv/analisar', { method: 'POST', body: formData });
                const data = await resp.json();

                if (data.erro) {
                    alert('Erro: ' + data.erro);
                    return;
                }

                csvJobId = data.job_id;
                csvImages = data.images;

                // Preencher resumo
                const textCount = data.images.filter(i => i.has_text).length;
                document.getElementById('csvSummary').innerHTML = `
                    <div class="csv-summary-item"><div class="value">${data.product_count}</div><div class="label">Produtos</div></div>
                    <div class="csv-summary-item"><div class="value">${data.total_images}</div><div class="label">Imagens</div></div>
                    <div class="csv-summary-item"><div class="value">${textCount}</div><div class="label">Com texto</div></div>
                `;

                // Preencher tabela
                const tbody = document.getElementById('csvImageTableBody');
                tbody.innerHTML = '';
                data.images.forEach(img => {
                    const badgeClass = img.source === 'gallery' ? 'badge-gallery' :
                                       img.source === 'variant' ? 'badge-variant' : 'badge-description';
                    const badgeLabel = img.source === 'gallery' ? 'Galeria' :
                                       img.source === 'variant' ? 'Variante' : 'Descri√ß√£o';
                    const textClass = img.has_text ? 'has-text' : 'no-text';
                    const textLabel = img.has_text ? '‚úÖ Tem texto' : '‚ö™ Sem texto';

                    tbody.innerHTML += `
                        <tr>
                            <td><input type="checkbox" class="csv-checkbox" data-index="${img.index}" data-has-text="${img.has_text}" ${img.has_text ? 'checked' : ''} onchange="updateCsvTraduzirBtn()"></td>
                            <td>${img.thumbnail ? `<img class="img-review-thumb" src="${img.thumbnail}">` : '<div style="width:60px;height:60px;background:#222;border-radius:6px;"></div>'}</td>
                            <td><span class="badge ${badgeClass}">${badgeLabel}</span></td>
                            <td style="color:var(--text-secondary);">${img.handle}</td>
                            <td><span class="text-indicator ${textClass}">${textLabel}</span></td>
                            <td style="color:var(--text-muted); font-size:0.78rem; max-width:200px;">${img.description || (img.error ? '‚ö†Ô∏è Erro ao baixar' : '')}</td>
                        </tr>
                    `;
                });

                // Mostrar fase 2
                document.getElementById('csvPhase1').classList.remove('visible');
                document.getElementById('csvPhase2').classList.add('visible');
                updateCsvTraduzirBtn();

            } catch (err) {
                alert('Erro de conex√£o: ' + err.message);
            } finally {
                document.getElementById('csvLoading1').classList.remove('visible');
                document.getElementById('btnAnalisar').disabled = false;
            }
        }

        // Fase 2‚Üí3: Traduzir via SSE
        function iniciarTraducaoCSV() {
            const imgs = getSelectedCsvImages();
            const langs = getSelectedCsvIdiomas();
            const marcaDe = document.getElementById('csvMarcaDe').value.trim();
            const marcaPara = document.getElementById('csvMarcaPara').value.trim();
            const traduzirTexto = document.getElementById('csvTraduzirTexto').checked;

            if (langs.length === 0 || (imgs.length === 0 && !traduzirTexto)) return;

            // Mostrar fase 3
            document.getElementById('csvPhase2').classList.remove('visible');
            document.getElementById('csvPhase3').classList.add('visible');
            document.getElementById('csvDownloadArea').style.display = 'none';
            document.getElementById('csvResultGrid').innerHTML = '';
            document.getElementById('csvProgressFill').style.width = '0%';
            document.getElementById('csvProgressPercent').textContent = '0%';
            document.getElementById('csvProgressLabel').textContent = 'Iniciando...';

            const params = new URLSearchParams({
                job_id: csvJobId,
                images: imgs.length > 0 ? imgs.join(',') : 'none',
                idiomas: langs.join(','),
                marca_de: marcaDe,
                marca_para: marcaPara,
                traduzir_texto: traduzirTexto ? 'true' : 'false',
            });

            const source = new EventSource(`/csv/traduzir/stream?${params}`);

            source.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'progress') {
                    const pct = Math.round((data.current / data.total) * 100);
                    document.getElementById('csvProgressFill').style.width = pct + '%';
                    document.getElementById('csvProgressPercent').textContent = pct + '%';
                    document.getElementById('csvProgressLabel').textContent =
                        `Traduzindo imagem ${data.image} ‚Üí ${data.language} (${data.current}/${data.total})`;
                }

                if (data.type === 'image_done') {
                    const pct = Math.round((data.current / data.total) * 100);
                    document.getElementById('csvProgressFill').style.width = pct + '%';
                    document.getElementById('csvProgressPercent').textContent = pct + '%';

                    if (data.preview) {
                        const grid = document.getElementById('csvResultGrid');
                        grid.innerHTML += `
                            <div class="csv-result-item">
                                <img src="${data.preview}" alt="${data.output_file}">
                                <div class="label">${FLAGS[data.lang_code] || ''} ${data.output_file}</div>
                            </div>
                        `;
                    }
                }

                if (data.type === 'text_progress') {
                    const pct = Math.round((data.current / data.total) * 100);
                    document.getElementById('csvProgressFill').style.width = pct + '%';
                    document.getElementById('csvProgressPercent').textContent = pct + '%';
                    document.getElementById('csvProgressLabel').textContent =
                        `Traduzindo texto "${data.handle}" ‚Üí ${data.language} (${data.current}/${data.total})`;
                }

                if (data.type === 'text_done') {
                    const pct = Math.round((data.current / data.total) * 100);
                    document.getElementById('csvProgressFill').style.width = pct + '%';
                    document.getElementById('csvProgressPercent').textContent = pct + '%';
                    // Adicionar indicador visual de texto traduzido
                    const grid = document.getElementById('csvResultGrid');
                    grid.innerHTML += `
                        <div class="csv-result-item" style="display:flex; align-items:center; justify-content:center; aspect-ratio:auto; padding:0.8rem;">
                            <div class="label" style="padding:0;">üìù ${data.handle} ‚Üí ${data.language}</div>
                        </div>
                    `;
                }

                if (data.type === 'error') {
                    console.error('CSV tradu√ß√£o erro:', data.message);
                    if (data.current && data.total) {
                        const pct = Math.round((data.current / data.total) * 100);
                        document.getElementById('csvProgressFill').style.width = pct + '%';
                        document.getElementById('csvProgressPercent').textContent = pct + '%';
                    }
                }

                if (data.type === 'complete') {
                    source.close();
                    document.getElementById('csvProgressFill').style.width = '100%';
                    document.getElementById('csvProgressPercent').textContent = '100%';
                    document.getElementById('csvProgressLabel').textContent = 'Tradu√ß√£o conclu√≠da!';
                    document.getElementById('csvDownloadBtn').href = data.download_url;
                    document.getElementById('csvDownloadArea').style.display = 'block';
                }
            };

            source.onerror = () => {
                source.close();
                document.getElementById('csvProgressLabel').textContent = 'Erro na conex√£o SSE. Tente novamente.';
            };
        }

        function novaAnaliseCSV() {
            // Reset tudo
            csvFile = null;
            csvJobId = null;
            csvImages = [];
            csvFileInput.value = '';
            document.getElementById('csvPlaceholder').style.display = '';
            document.getElementById('csvFileInfo').style.display = 'none';
            csvUploadArea.classList.remove('has-file');
            document.getElementById('btnAnalisar').disabled = true;

            document.getElementById('csvPhase3').classList.remove('visible');
            document.getElementById('csvPhase2').classList.remove('visible');
            document.getElementById('csvPhase1').classList.add('visible');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
